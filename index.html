<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Googleカレンダー連携</title>

    <!-- FullCalendarのCSSファイル -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet" />

    <!-- jQueryの読み込み -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Google APIクライアントライブラリ -->
    <script src="https://apis.google.com/js/api.js"></script>

    <!-- Google Identity Servicesライブラリ -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- FullCalendarのJSファイル -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 50px;
      }
      #calendar {
        max-width: 900px;
        margin: 50px auto;
        border: 1px solid #ccc;
        height: 600px;
      }
    </style>
  </head>
  <body>
    <h1>Googleカレンダー連携</h1>

    <!-- サインインとサインアウトのボタン -->
    <button id="signin-button">Googleにサインイン</button>
    <button id="signout-button" style="display:none;">サインアウト</button>

    <!-- カレンダーを表示する領域 -->
    <div id="calendar"></div>

    <script>
      let tokenClient;  // OAuth 2.0トークンを管理するクライアント
      let accessToken = null;  // 認証後に取得するアクセストークンを保存する変数
      let calendar;  // FullCalendarインスタンスを保持する変数
      let gapiInitialized = false;  // gapiが初期化されたかどうかを追跡
      let gisInitialized = false;  // Google Identity Servicesが初期化されたかどうかを追跡

      // Google APIの設定情報
      const CLIENT_ID = '374829471697-oha7qmu5t48k6posh3t2gf4ev2tj19v7.apps.googleusercontent.com';  // Google Cloudで取得したクライアントID
      const API_KEY = 'AIzaSyB3j2AThdjPW9Mx__tXM0lPZK9MFRhYmSo';  // Google Cloudで取得したAPIキー
      const SCOPES = 'https://www.googleapis.com/auth/calendar';  // Google Calendarのアクセス権限（スコープ）

      // 会社とプライベートのGoogleカレンダーID
      const companyCalendarId = 'komoro@solairo.co.jp';  // 会社のカレンダーID
      const personalCalendarId = 'yasukokomoro@yahoo.co.jp';  // プライベートのカレンダーID

      // Google Identity Servicesの読み込み完了後に呼び出される関数
      function gisLoaded() {
        console.log("Google Identity Services Loaded");
        gisInitialized = true;
        maybeInitializeTokenClient();  // GISが読み込まれたらトークンクライアントを初期化
      }

      // Google APIクライアントの初期化処理
      function gapiLoaded() {
        console.log("Google API Client Loaded");
        if (typeof gapi !== 'undefined') {
          gapi.load('client:auth2', initClient);  // gapiクライアントを読み込む
        } else {
          console.error("gapi is not defined");
        }
      }

      // Google APIクライアントの初期化
      function initClient() {
        console.log("Initializing Google API Client...");
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],
        }).then(function () {
          console.log("Google API Client Initialized");
          gapiInitialized = true;
        }).catch(function(error) {
          console.error("gapi client initialization failed:", error);
        });
      }

      // トークンクライアントの初期化
      function maybeInitializeTokenClient() {
        if (gisInitialized && typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
          console.log("Initializing Token Client...");
          tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (tokenResponse) => {
              console.log("Access Token Received");
              accessToken = tokenResponse.access_token;
              $('#signin-button').hide();
              $('#signout-button').show();
              gapi.client.setToken({ access_token: accessToken });
              maybeInitializeCalendar();
            },
          });
        } else {
          console.error("Google Identity Servicesライブラリが読み込まれていません。");
        }
      }

      // サインインボタンのクリックイベント
      $('#signin-button').on('click', function() {
        if (tokenClient) {
          console.log("Requesting Access Token...");
          tokenClient.requestAccessToken();  // アクセストークンのリクエスト
        } else {
          console.error("トークンクライアントが初期化されていません。");
        }
      });

      // サインアウトボタンのクリックイベント
      $('#signout-button').on('click', function() {
        accessToken = null;
        $('#signin-button').show();
        $('#signout-button').hide();
        gapi.client.setToken(null);  // トークンをクリア
        console.log("Signed Out");
      });

      // カレンダーの初期化
      function maybeInitializeCalendar() {
        if (gapiInitialized && accessToken) {
          console.log("Initializing Calendar...");
          loadCalendar();  // カレンダーを初期化する
        } else {
          console.log("Cannot initialize calendar yet. gapiInitialized:", gapiInitialized, "accessToken:", accessToken);
        }
      }

      // FullCalendarの設定とGoogleカレンダーのイベント読み込み
      function loadCalendar() {
        if (!accessToken) {
          console.log("Access token is missing, cannot load calendar");
          return;
        }

        console.log("Loading Calendar...");

        try {
          // FullCalendarのインスタンスを作成
          var calendarEl = document.getElementById('calendar');
          calendar = new FullCalendar.Calendar(calendarEl, {
            headerToolbar: {
              left: 'prev,next today',
              center: 'title',
              right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            selectable: true,
            editable: true,
            initialView: 'dayGridMonth',

            // GoogleカレンダーのAPIキーをGoogleカレンダーイベントのソースに設定
            eventSources: [
              {
                googleCalendarApiKey: API_KEY,  // APIキー
                googleCalendarId: companyCalendarId,  // 会社のカレンダーID
                className: 'company-calendar',
                failure: function() {
                  console.error("会社用カレンダーの読み込みに失敗しました。");
                },
                success: function(events) {
                  console.log(events.length + "件の会社用カレンダーイベントを読み込みました。");
                }
              },
              {
                googleCalendarApiKey: API_KEY,  // APIキー
                googleCalendarId: personalCalendarId,  // プライベートのカレンダーID
                className: 'personal-calendar'
              }
            ],

            // イベントクリック時の処理
            eventClick: function(info) {
              if (confirm("このイベントを削除しますか？")) {
                deleteEvent(info.event);
              }
            },

            // 新しいイベントをカレンダーに追加
            select: function(info) {
              var title = prompt('イベントのタイトル:');
              if (title) {
                var selectedCalendarId = prompt('どのカレンダーに追加しますか？\n1. 会社用\n2. プライベート', '1') === '1' 
                  ? companyCalendarId 
                  : personalCalendarId;

                var event = {
                  'summary': title,
                  'start': {
                    'dateTime': info.startStr,
                    'timeZone': 'Asia/Tokyo'
                  },
                  'end': {
                    'dateTime': info.endStr,
                    'timeZone': 'Asia/Tokyo'
                  }
                };

                gapi.client.calendar.events.insert({
                  'calendarId': selectedCalendarId,
                  'resource': event
                }).then(function(event) {
                  calendar.addEvent({
                    title: title,
                    start: info.startStr,
                    end: info.endStr,
                    id: event.result.id,
                    extendedProps: {
                      googleCalendarId: selectedCalendarId
                    }
                  });
                });
              }
              calendar.unselect();
            }
          });

          console.log("Rendering Calendar...");
          calendar.render();  // FullCalendarをレンダリングして表示
        } catch (error) {
          console.error("Error during FullCalendar initialization:", error);
        }
      }

      // Googleカレンダーからイベントを削除する関数
      function deleteEvent(event) {
        var calendarId = event.extendedProps.googleCalendarId;
        var eventId = event.id;

        gapi.client.calendar.events.delete({
          'calendarId': calendarId,
          'eventId': eventId
        }).then(function() {
          event.remove();  // FullCalendarからもイベントを削除
        });
      }

      // ページロード後に初期化を行う
      window.onload = function() {
        console.log("Page Loaded");
        gapiLoaded();  // Google APIクライアントの初期化
        gisLoaded();   // Google Identity Servicesの初期化
      };
    </script>
  </body>
</html>
